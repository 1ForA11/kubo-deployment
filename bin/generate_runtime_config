#!/usr/bin/env bash

set -e
set -o pipefail

[ -z "${DEBUG}" ] || set -x

print_usage() {
cat << EOF
  Usage: $0 <BOSH environment path>
EOF
}

repo_directory() {
  echo -n "$(cd "$(dirname "${BASH_SOURCE[0]}")/.."; pwd)"
}

main() {
  if [ $# -ne 1 ] ; then
    print_usage
    exit 1
  fi

  local bosh_env=$(cd "$1"; pwd)
  local deploy_diagnostics="$(bosh-cli int ${bosh_env}/director.yml --path '/deploy_diagnostics')"
  local runtime_config

  if [ "true" == "$deploy_diagnostics" ]; then
    runtime_config=$(bosh-cli int "$(repo_directory)/manifests/turbulence/runtime-config.yml" --vars-file ${bosh_env}/director.yml --vars-file ${bosh_env}/creds.yml)
  fi

  echo -n "${runtime_config}"
}

[[ "$0" == "${BASH_SOURCE[0]}" ]] && main "$@"
